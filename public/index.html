<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>BeagleBone IoT Device Management</title>
    <link
      href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  </head>
  <body>
    <div class="container mt-5">
      <h1 class="text-center">BeagleBone IoT Device Management</h1>

      <!-- List Connections Section -->
      <div class="card mt-4">
        <div class="card-header">List All Device Connections</div>
        <div class="card-body">
          <button id="listConnectionsBtn" class="btn btn-primary">
            List Connections
          </button>
          <div id="connectionsCount" class="mt-3"></div>
          <div id="connectionsResult" class="mt-3"></div>
        </div>
      </div>

      <!-- Read Data Section -->
      <div class="card mt-4">
        <div class="card-header">Read Data from Device</div>
        <div class="card-body">
          <div class="form-group">
            <label for="deviceSelectRead">Select Device</label>
            <select class="form-control" id="deviceSelectRead"></select>
          </div>
          <button id="readDataBtn" class="btn btn-primary">Read Data</button>
          <div id="readDataResult" class="mt-3"></div>
        </div>
      </div>

      <!-- Update Register Section -->
      <div class="card mt-4">
        <div class="card-header">Update Device Register</div>
        <div class="card-body">
          <div class="form-group">
            <label for="deviceSelectUpdate">Select Device</label>
            <select class="form-control" id="deviceSelectUpdate"></select>
          </div>
          <form id="updateRegisterForm">
            <div class="form-group">
              <label for="registerAddress"
                >Register Address<small>(Moisture Set Point 17)</small></label
              >
              <input
                type="text"
                class="form-control"
                id="registerAddress"
                value="17"
                required
              />
            </div>
            <div class="form-group">
              <label for="newValue">New Value </label>
              <input type="text" class="form-control" id="newValue" required />
            </div>
            <button type="submit" class="btn btn-primary">
              Update Register
            </button>
          </form>
          <div id="updateRegisterResult" class="mt-3"></div>
        </div>
      </div>
    </div>

    <script>
      $(document).ready(function () {
        // Fetch all connections on page load and every 3 seconds
        fetchConnections();
        setInterval(fetchConnections, 3000);

        // Handle List Connections button click
        $('#listConnectionsBtn').on('click', function () {
          fetchConnections();
        });

        function fetchConnections() {
          $.ajax({
            url: '/api/devices/connections',
            method: 'GET',
            success: function (response) {
              displayConnections(response);
            },
            error: function (xhr) {
              $('#connectionsResult').html(
                '<div class="alert alert-danger">Error: ' +
                  xhr.responseJSON.message +
                  '</div>'
              );
            },
          });
        }

        function displayConnections(data) {
          if (data.totalConnections === 0) {
            $('#connectionsCount').html(
              '<div class="alert alert-info">No devices connected.</div>'
            );
            $('#connectionsResult').html('');
            $('#deviceSelectRead').html(
              '<option value="">Select a device</option>'
            );
            $('#deviceSelectUpdate').html(
              '<option value="">Select a device</option>'
            );
            return;
          }

          $('#connectionsCount').html(
            '<div class="alert alert-info">Total Connections: ' +
              data.totalConnections +
              '</div>'
          );

          var connectionsHtml = '<table class="table table-bordered">';
          connectionsHtml +=
            '<thead><tr><th>Serial Number</th><th>Model</th><th>Status</th><th>Last Ping</th><th>Actions</th></tr></thead>';
          connectionsHtml += '<tbody>';

          var deviceSelectReadHtml =
            '<option value="">Select a device</option>';
          var deviceSelectUpdateHtml =
            '<option value="">Select a device</option>';

          data.connections.forEach(function (connection) {
            if (connection.deviceStatus === 'online') {
              var lastPingLocalTime = new Date(
                connection.lastPingTime
              ).toLocaleString();

              connectionsHtml += '<tr>';
              connectionsHtml += '<td>' + connection.serialNumber + '</td>';
              connectionsHtml += '<td>' + connection.model + '</td>';
              connectionsHtml += '<td>' + connection.deviceStatus + '</td>';
              connectionsHtml += '<td>' + lastPingLocalTime + '</td>';
              connectionsHtml +=
                '<td><button class="btn btn-primary btn-sm read-data-btn" data-serial-number="' +
                connection.serialNumber +
                '">Read Data</button></td>';
              connectionsHtml += '</tr>';

              deviceSelectReadHtml +=
                '<option value="' +
                connection.serialNumber +
                '">' +
                connection.model +
                ' (' +
                connection.serialNumber +
                ')</option>';
              deviceSelectUpdateHtml +=
                '<option value="' +
                connection.serialNumber +
                '">' +
                connection.model +
                ' (' +
                connection.serialNumber +
                ')</option>';
            }
          });

          connectionsHtml += '</tbody></table>';
          $('#connectionsResult').html(connectionsHtml);

          $('#deviceSelectRead').html(deviceSelectReadHtml);
          $('#deviceSelectUpdate').html(deviceSelectUpdateHtml);

          // Add click event for Read Data buttons
          $('.read-data-btn').on('click', function () {
            var serialNumber = $(this).data('serial-number');
            $('#deviceSelectRead').val(serialNumber);
            $('#readDataBtn').click();
          });
        }

        // Handle Read Data button click
        $('#readDataBtn').on('click', function () {
          var serialNumber = $('#deviceSelectRead').val();
          if (!serialNumber) {
            $('#readDataResult').html(
              '<div class="alert alert-danger">Please select a device.</div>'
            );
            return;
          }
          $.ajax({
            url: '/api/devices/read-data',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ serialNumber: serialNumber }),
            success: function (response) {
              displayReadData(response);
            },
            error: function (xhr) {
              $('#readDataResult').html(
                '<div class="alert alert-danger">Error: ' +
                  xhr.responseJSON.message +
                  '</div>'
              );
            },
          });
        });

        function displayReadData(data) {
          if (data.status !== 'Data received') {
            $('#readDataResult').html(
              '<div class="alert alert-danger">Error: Data not received.</div>'
            );
            return;
          }

          var readDataHtml = '<table class="table table-bordered">';
          readDataHtml +=
            '<thead><tr><th>Tag Name</th><th>Value</th></tr></thead>';
          readDataHtml += '<tbody>';

          data.data.forEach(function (item) {
            readDataHtml += '<tr>';
            readDataHtml += '<td>' + item.tagName + '</td>';
            readDataHtml += '<td>' + item.value + '</td>';
            readDataHtml += '</tr>';
          });

          readDataHtml += '</tbody></table>';
          $('#readDataResult').html(readDataHtml);

          // Set the default serial number for the update form
          $('#deviceSelectUpdate').val($('#deviceSelectRead').val());
        }

        // Handle Update Register form submission
        $('#updateRegisterForm').on('submit', function (event) {
          event.preventDefault();
          var serialNumber = $('#deviceSelectUpdate').val();
          var registerAddress = $('#registerAddress').val();
          var newValue = $('#newValue').val();
          if (!serialNumber) {
            $('#updateRegisterResult').html(
              '<div class="alert alert-danger">Please select a device.</div>'
            );
            return;
          }
          $.ajax({
            url: '/api/devices/update-register',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
              serialNumber: serialNumber,
              registerAddress: registerAddress,
              newValue: newValue,
            }),
            success: function (response) {
              $('#updateRegisterResult').html(
                '<div class="alert alert-success">Register updated successfully.</div><pre>' +
                  JSON.stringify(response, null, 2) +
                  '</pre>'
              );
            },
            error: function (xhr) {
              $('#updateRegisterResult').html(
                '<div class="alert alert-danger">Error: ' +
                  xhr.responseJSON.message +
                  '</div>'
              );
            },
          });
        });
      });
    </script>
  </body>
</html>
